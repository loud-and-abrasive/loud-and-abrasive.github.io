<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Database Migrations For Azure SQL Elastic Pools Using RoundhousE |  Loud &amp; Abrasive: Patrick McVeety-Mill</title>
<link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.png" >

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&family=Montserrat+Alternates&family=Montserrat:wght@300&family=Vibur&display=swap" rel="stylesheet"> 
<script src="https://kit.fontawesome.com/69fa8fd1fe.js" crossorigin="anonymous"></script>

<link rel="stylesheet" href="/assets/main.css">
<link rel="stylesheet" href="/assets/syntax.css">

<link rel="alternate" type="application/atom+xml" title="Loud &amp; Abrasive: Patrick McVeety-Mill" href="/feed.xml"/>
<link rel="alternate" type="application/rss+xml"  title="Loud &amp; Abrasive: Patrick McVeety-Mill" href="/feed.xml"> 

<script>
  window.backOrHome = function() {
    if(window.history.length <= 1){
      window.location.replace('/')
    } else{
      history.back();
    }
  };
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-49372703-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-49372703-1');
</script>



<!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Database Migrations For Azure SQL Elastic Pools Using RoundhousE" />
<meta name="author" content="Patrick McVeety-Mill" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Databases are important for most applications, but keeping their schemas consistent across versions and environments can become a sticky date pudding without proper care. Tools like RoundhousE provide streamlined, repeatable, script-based migrations and work like a charm out of the box. If using the very cool and atmospheric Azure SQL Elastic Pools, however, the default behavior lands us adjacent to the pool, not in it. Let’s not be hasty to abandon database host nor migrator; it’s easy to correct this with little configuration." />
<meta property="og:description" content="Databases are important for most applications, but keeping their schemas consistent across versions and environments can become a sticky date pudding without proper care. Tools like RoundhousE provide streamlined, repeatable, script-based migrations and work like a charm out of the box. If using the very cool and atmospheric Azure SQL Elastic Pools, however, the default behavior lands us adjacent to the pool, not in it. Let’s not be hasty to abandon database host nor migrator; it’s easy to correct this with little configuration." />
<link rel="canonical" href="http://loudandabrasive.com/roundhouse-db-migrations-azure-elastic-pools" />
<meta property="og:url" content="http://loudandabrasive.com/roundhouse-db-migrations-azure-elastic-pools" />
<meta property="og:site_name" content="Loud &amp; Abrasive: Patrick McVeety-Mill" />
<meta property="og:image" content="http://loudandabrasive.com/assets/default-card-image.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-15T09:24:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://loudandabrasive.com/assets/default-card-image.jpg" />
<meta property="twitter:title" content="Database Migrations For Azure SQL Elastic Pools Using RoundhousE" />
<meta name="twitter:site" content="@loudandabrasive" />
<meta name="twitter:creator" content="@loudandabrasive" />
<script type="application/ld+json">
{"description":"Databases are important for most applications, but keeping their schemas consistent across versions and environments can become a sticky date pudding without proper care. Tools like RoundhousE provide streamlined, repeatable, script-based migrations and work like a charm out of the box. If using the very cool and atmospheric Azure SQL Elastic Pools, however, the default behavior lands us adjacent to the pool, not in it. Let’s not be hasty to abandon database host nor migrator; it’s easy to correct this with little configuration.","url":"http://loudandabrasive.com/roundhouse-db-migrations-azure-elastic-pools","@type":"BlogPosting","image":"http://loudandabrasive.com/assets/default-card-image.jpg","headline":"Database Migrations For Azure SQL Elastic Pools Using RoundhousE","dateModified":"2019-10-15T09:24:00+00:00","datePublished":"2019-10-15T09:24:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://loudandabrasive.com/roundhouse-db-migrations-azure-elastic-pools"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://loudandabrasive.com/assets/loudandalogo.png"},"name":"Patrick McVeety-Mill"},"author":{"@type":"Person","name":"Patrick McVeety-Mill"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
  <body>

    <header class="top">
  <div class="title-container">
  <span class="subtitle">Patrick McVeety-Mill:</span>
  <h1 class="title">
    <a href="/">Loud &amp; Abrasive</a>
  </h1>
</div>

<nav>
  <input id="nav-toggle-check" name="nav-toggle-check" type="checkbox" class="nav-toggle" />
  <label for="nav-toggle-check" class="nav-toggle">
    <i class="fas fa-bars"></i>
  </label>

  <ul class="page-list">
    
      
      
        <li class="nav-link-vermilion">
          <a href="/tech/index.html">
            Tech <i class="fas fa-code-branch"></i>
          </a>
        </li>
      
    
      
      
        <li class="nav-link-orange">
          <a href="/life/index.html">
            Life <i class="fas fa-hiking"></i>
          </a>
        </li>
      
    
      
      
        <li class="nav-link-citron">
          <a href="/arts/index.html">
            Arts <i class="fas fa-paint-brush"></i>
          </a>
        </li>
      
    
      
      
        <li class="nav-link-teal">
          <a href="/about/">
            About <i class="fas fa-bullhorn"></i>
          </a>
        </li>
      
    
    <li class="nav-link-charcoal">
      <a href="/feed.xml" target="_blank" class="hover-charcoal">Subscribe <i class="fas fa-rss"></i></a>
    </li>
  </ul>

  <hr class="stripes mobile-stripes" />
</nav>

</header>
<hr class="stripes top-stripes" />

<main class="site-content" aria-label="Content">
  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Database Migrations For Azure SQL Elastic Pools Using RoundhousE</h1>
    <div class="post-meta">
      <div>
        <span class="post-category vermilion">Cloud</span>
        published
        <time datetime="2019-10-15T09:24:00+00:00" itemprop="datePublished">
          
          Oct 15, 2019
        </time>
      </div>
      
        regarding azure | sql | roundhouse
      
    </div>
  </header>

  <div class="post-content" aria-label="Content" itemprop="articleBody">
    <p>Databases are important for most applications, but keeping their schemas consistent across versions and environments can become a sticky date pudding without proper care. Tools like <a href="https://github.com/chucknorris/roundhouse">RoundhousE</a> provide streamlined, repeatable, script-based migrations and work like a charm out of the box. If using the very cool and atmospheric <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-elastic-pool">Azure SQL Elastic Pools</a>, however, the default behavior lands us adjacent to the pool, not in it. Let’s not be hasty to abandon database host nor migrator; it’s easy to correct this with little configuration. <!--more--></p>

<h2 id="not-the-desired-databases">Not The Desired Databases</h2>

<p>RoundhousE is kind to its users and <a href="https://github.com/chucknorris/roundhouse/wiki/CustomCreateDatabase">creates databases if they do not exist</a> at the start of a migration. When working with Azure SQL, this creates a <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-single-database">single database</a> on the connected <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-servers">database server</a>. That certainly fits as expected behavior, but if you’ve provisioned an elastic pool on your Azure SQL Server, you’ll find it sadly empty after a first-time migration.</p>

<p>Databases can be pushed into the pool (not recommended for physical servers) after the fact from the Azure Portal or CLI, but I’m lazy and would prefer RoundhousE to carry me the whole way through.</p>

<h2 id="custom-database-create">Custom Database Create</h2>

<p>RoundhousE is as easy to customize as it is to use unconfigured, and provides a flag for overriding the default create database behavior in favor of a  <a href="https://github.com/chucknorris/roundhouse/wiki/CustomCreateDatabase">custom script</a> (<code class="language-plaintext highlighter-rouge">-cds</code>). This script can then leverage the <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-database-service-objectives-azure-sql-database">T-SQL instruction</a> for <em>where</em> to create an Azure SQL database: <code class="language-plaintext highlighter-rouge">SERVICE_OBJECTIVE</code>. We can adapt RoundhousE’s <a href="https://github.com/chucknorris/roundhouse/blob/master/product/roundhouse.databases.sqlserver/SqlServerDatabase.cs#L108-L115">sample custom create script</a> to set both the service objective and the elastic pool’s name:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">Created</span> <span class="nb">bit</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">Created</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">databases</span> <span class="k">WHERE</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span>
<span class="k">BEGIN</span>
        <span class="k">Set</span> <span class="o">@</span><span class="n">Created</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">CREATE</span> <span class="k">DATABASE</span> 
        <span class="p">(</span> <span class="n">SERVICE_OBJECTIVE</span> <span class="o">=</span> <span class="n">ELASTIC_POOL</span> <span class="p">(</span> <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="o">#</span><span class="n">REPLACE_ELASTIC_POOL_NAME</span><span class="o">#</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">END</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">Created</span>
</code></pre></div></div>

<p>At runtime, RoundhousE will connect as normal, but will run the above before any migration scripts. The ` {{DatabaseName}} ` token will be filled in automatically, but <code class="language-plaintext highlighter-rouge">#REPLACE_ELASTIC_POOL_NAME#</code> will need to be hard-coded, or better yet plugged by some other process.</p>

<h2 id="using-in-a-cicd-pipeline">Using in a CI/CD Pipeline</h2>

<p>That works fine for a single elastic pool, but hard-coding names is brittle and may not work across environments. We give the script a little nudge; personally, I use powershell to plug in the elastic pool name from an environment variable, before calling RoundhousE:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$replacedContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Content</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nv">$createDbScript</span><span class="w"> </span><span class="nt">-Raw</span><span class="p">)</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s1">'#REPLACE_ELASTIC_POOL_NAME#'</span><span class="p">,</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">ElasticPoolName</span><span class="w">

</span><span class="n">Set-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$createDbScript</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$replacedContent</span><span class="w">

</span><span class="o">&amp;</span><span class="nv">$roundhouse_exe_path</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">MyConnectionString</span><span class="s2">"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="s2">"./scripts/"</span><span class="w"> </span><span class="nt">-cds</span><span class="w"> </span><span class="nv">$createDbScript</span><span class="w"> </span><span class="nt">--env</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Environment</span><span class="w"> </span><span class="nt">--vf</span><span class="w"> </span><span class="n">MyApp.dll</span><span class="w">
</span></code></pre></div></div>

<p>If you use other kinds of SQL hosts besides elastic pools, you can set a flag to only conditionally use the <code class="language-plaintext highlighter-rouge">-cds</code> option, or if you prefer writing SQL, knock yourself out on the create script.</p>

<p>Whether or not you need to get fancy, it’s important to noodle around with our tools in the face of odd behavior, especially if it allows us to use more ideal technologies.</p>

  </div>

  <a class="outline-link" href="javascript:window.backOrHome()">
    <i class="fas fa-chevron-left vermilion"><i class="fas fa-chevron-left orange"></i></i><i class="fas fa-chevron-left citron"></i><i class="fas fa-chevron-left teal"></i>
    Return
  </a>

  
</article>

</main>


    <hr class="footer-stripes" />

<footer class="site-footer">
  <span class="copy">&copy; 2021 Loud & Abrasive & Co.</span>
  <ul class="social-links">
    
      
      
      <li><a href="https://twitter.com/loudandabrasive" title="Twitter" target="_blank"><i class="fab fa-twitter hover-vermilion"></i></a></li>
      
    
      
      
      <li><a href="https://linkedin.com/in/pmcvtm" title="LinkedIn" target="_blank"><i class="fab fa-linkedin-in hover-orange"></i></a></li>
      
    
      
      
      <li><a href="https://github.com/pmcvtm" title="Github" target="_blank"><i class="fab fa-github hover-citron"></i></a></li>
      
    
      
      
      <li><a href="https://bandcamp.com/loudandabrasive" title="Bandcamp" target="_blank"><i class="fab fa-bandcamp hover-teal"></i></a></li>
      
    
      
      
      <li><a href="https://letterboxd.com/loudandabrasive/" title="Letterboxd" target="_blank"><i class="fab fa-pied-piper hover-charcoal"></i></a></li>
      
    
      
      
      <li><a href="https://untappd.com/user/loudandabrasive" title="Untappd" target="_blank"><i class="fab fa-untappd hover-vermilion"></i></a></li>
      
    
      
      
      <li><a href="https://goodreads.com/loudandabrasive/" title="Goodreads" target="_blank"><i class="fab fa-goodreads-g hover-orange"></i></a></li>
      
    
      
      
      <li><a href="https://instagram.com/loudandabrasive" title="Instagram" target="_blank"><i class="fab fa-instagram hover-citron"></i></a></li>
      
    
    <li><a class="rss" title="Subscribe" target="_blank" href="/feed.xml"><i class="fas fa-rss"></i></a></li>
  </ul>
</footer>


  </body>
</html>
